{"version":3,"file":"rplace.min.js","sources":["../src/rplace.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Allows to draw pattern\n *\n * @module     mod_rplace/rplace\n * @copyright  2024 Marina Glancy\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Ajax from 'core/ajax';\nimport * as PubSub from 'core/pubsub';\nimport * as RealTimeEvents from 'tool_realtime/events';\nimport * as Notification from 'core/notification';\n\nconst SELECTORS = {\n    PATTERNTABLE: '.mod_rplace_pattern',\n    CHOOSERTABLE: '.mod_rplace_chooser',\n    PATTERNTD: '.mod_rplace_pattern td',\n    CLICKABLEPATTERNTD: '.mod_rplace_pattern.clickable td',\n    CHOOSERTD: '.mod_rplace_chooser td',\n    CLICKABLECHOOSERTD: '.mod_rplace_chooser.clickable td',\n};\n\nlet colors = ['#ffffff'];\nlet currentColor = 2;\n\nconst setBgColor = (el, colorId) => {\n    let style = 'background-color: ' + colors[colorId];\n    if (colors[colorId] === '#000000') {\n        style += '; color: #ffffff';\n    }\n    el.style = style;\n};\n\nconst redraw = (pattern) => {\n    const patternrows = ('' + pattern).split(/\\n/);\n    document.querySelectorAll(SELECTORS.PATTERNTD).forEach(el => {\n        const x = parseInt(el.dataset.x);\n        const y = parseInt(el.dataset.y);\n        let value = (patternrows[y] ?? '').charCodeAt(x);\n        value = (isNaN(value) ? 48 : value) - 48;\n        setBgColor(el, value);\n    });\n};\n\nconst setCurrentColor = (colorId) => {\n    document.querySelectorAll(SELECTORS.CLICKABLECHOOSERTD).forEach(el => {\n        const id = parseInt(el.dataset.id);\n        el.innerHTML = (id === colorId) ? 'X' : '&nbsp;';\n    });\n    currentColor = colorId;\n};\n\nexport const init = (cmid, colorset) => {\n    colors = colorset;\n    setCurrentColor(Math.floor(Math.random() * colors.length));\n\n    const patternTable = document.querySelector(SELECTORS.PATTERNTABLE);\n    if (!patternTable) {\n        return;\n    }\n\n    const initalpattern = patternTable.dataset.pattern;\n    redraw(initalpattern);\n\n    document.querySelectorAll(SELECTORS.CHOOSERTD).forEach(el => {\n        setBgColor(el, parseInt(el.dataset.id));\n    });\n\n    document.querySelectorAll(SELECTORS.CLICKABLEPATTERNTD).forEach(el => {\n        el.addEventListener('click', (e) => {\n            e.preventDefault();\n            el.style = 'background-color: ' + colors[currentColor];\n            Ajax.call([{\n                methodname: 'mod_rplace_paint',\n                args: {\n                    cmid: parseInt(cmid), x: parseInt(el.dataset.x), y: parseInt(el.dataset.y), color: currentColor\n                }\n            }]);\n        });\n    });\n\n    document.querySelectorAll(SELECTORS.CLICKABLECHOOSERTD).forEach(el => {\n        el.addEventListener('click', (e) => {\n            e.preventDefault();\n            setCurrentColor(parseInt(el.dataset.id));\n        });\n    });\n\n    PubSub.subscribe(RealTimeEvents.CONNECTION_LOST, (e) => {\n        window.console.log('Error', e);\n        Notification.exception({\n            name: 'Error',\n            message: 'Something went wrong, please refresh the page'});\n    });\n\n    PubSub.subscribe(RealTimeEvents.EVENT, function(eventData) {\n        const data = eventData?.context?.component ? eventData.context : eventData;\n        if (!data.payload || data.component != 'mod_rplace' || data.area != 'pattern' || data.itemid != cmid) {\n            return;\n        }\n\n        // window.console.log('--- event:', eventData);\n        const updates = data.payload.updates;\n        const el = updates ? document.querySelector(SELECTORS.CLICKABLEPATTERNTD +\n            `[data-x=\"${updates.x}\"][data-y=\"${updates.y}\"]`) : null;\n        if (el) {\n            setBgColor(el, updates.color);\n        } else {\n            const pattern = data.payload.pattern;\n            if (pattern) {\n                redraw(pattern);\n            }\n        }\n    });\n};\n"],"names":["SELECTORS","colors","currentColor","setBgColor","el","colorId","style","redraw","pattern","patternrows","split","document","querySelectorAll","forEach","x","parseInt","dataset","y","value","charCodeAt","isNaN","setCurrentColor","id","innerHTML","cmid","colorset","Math","floor","random","length","patternTable","querySelector","initalpattern","addEventListener","e","preventDefault","Ajax","call","methodname","args","color","PubSub","subscribe","RealTimeEvents","CONNECTION_LOST","window","console","log","Notification","exception","name","message","EVENT","eventData","data","context","component","payload","area","itemid","updates"],"mappings":";;;;;;;4QA4BMA,uBACY,sBADZA,oBAGS,yBAHTA,6BAIkB,mCAJlBA,oBAKS,yBALTA,6BAMkB,uCAGpBC,OAAS,CAAC,WACVC,aAAe,QAEbC,WAAa,CAACC,GAAIC,eAChBC,MAAQ,qBAAuBL,OAAOI,SAClB,YAApBJ,OAAOI,WACPC,OAAS,oBAEbF,GAAGE,MAAQA,OAGTC,OAAUC,gBACNC,aAAe,GAAKD,SAASE,MAAM,MACzCC,SAASC,iBAAiBZ,qBAAqBa,SAAQT,8BAC7CU,EAAIC,SAASX,GAAGY,QAAQF,GACxBG,EAAIF,SAASX,GAAGY,QAAQC,OAC1BC,8BAAST,YAAYQ,4CAAM,IAAIE,WAAWL,GAC9CI,OAASE,MAAMF,OAAS,GAAKA,OAAS,GACtCf,WAAWC,GAAIc,WAIjBG,gBAAmBhB,UACrBM,SAASC,iBAAiBZ,8BAA8Ba,SAAQT,WACtDkB,GAAKP,SAASX,GAAGY,QAAQM,IAC/BlB,GAAGmB,UAAaD,KAAOjB,QAAW,IAAM,YAE5CH,aAAeG,uBAGC,CAACmB,KAAMC,YACvBxB,OAASwB,SACTJ,gBAAgBK,KAAKC,MAAMD,KAAKE,SAAW3B,OAAO4B,eAE5CC,aAAenB,SAASoB,cAAc/B,4BACvC8B,0BAICE,cAAgBF,aAAad,QAAQR,QAC3CD,OAAOyB,eAEPrB,SAASC,iBAAiBZ,qBAAqBa,SAAQT,KACnDD,WAAWC,GAAIW,SAASX,GAAGY,QAAQM,QAGvCX,SAASC,iBAAiBZ,8BAA8Ba,SAAQT,KAC5DA,GAAG6B,iBAAiB,SAAUC,IAC1BA,EAAEC,iBACF/B,GAAGE,MAAQ,qBAAuBL,OAAOC,cACzCkC,KAAKC,KAAK,CAAC,CACPC,WAAY,mBACZC,KAAM,CACFf,KAAMT,SAASS,MAAOV,EAAGC,SAASX,GAAGY,QAAQF,GAAIG,EAAGF,SAASX,GAAGY,QAAQC,GAAIuB,MAAOtC,uBAMnGS,SAASC,iBAAiBZ,8BAA8Ba,SAAQT,KAC5DA,GAAG6B,iBAAiB,SAAUC,IAC1BA,EAAEC,iBACFd,gBAAgBN,SAASX,GAAGY,QAAQM,WAI5CmB,OAAOC,UAAUC,eAAeC,iBAAkBV,IAC9CW,OAAOC,QAAQC,IAAI,QAASb,GAC5Bc,aAAaC,UAAU,CACnBC,KAAM,QACNC,QAAS,qDAGjBV,OAAOC,UAAUC,eAAeS,OAAO,SAASC,wCACtCC,KAAOD,MAAAA,sCAAAA,UAAWE,0DAASC,UAAYH,UAAUE,QAAUF,cAC5DC,KAAKG,SAA6B,cAAlBH,KAAKE,WAA0C,WAAbF,KAAKI,MAAqBJ,KAAKK,QAAUnC,kBAK1FoC,QAAUN,KAAKG,QAAQG,QACvBxD,GAAKwD,QAAUjD,SAASoB,cAAc/B,gDAC5B4D,QAAQ9C,wBAAe8C,QAAQ3C,SAAS,QACpDb,GACAD,WAAWC,GAAIwD,QAAQpB,WACpB,OACGhC,QAAU8C,KAAKG,QAAQjD,QACzBA,SACAD,OAAOC"}